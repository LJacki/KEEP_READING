# Verilog HDL 编程规范

编程规范的重要性表现在：

1. 良好的编程规范有助于综合软件准确理解编程者的意图，实现最佳电路结构，电路时序或面积能够达到最优平衡；
2. 提高系统的可移植性和可维护性，提高团队成员之间的沟通效率，方便第三方测试；
3. HDL的规范化能够体现编码人员的基本素质和整个团队的风貌。

另外，一个良好的编码规范实际能够帮助团队实现类似软件开发中的**模式设计**。正常请情况下，一个IC项目80%的开发内容属于某种常规模式设计的开发，如果对这部分内容采用正确的模板进行设计，必然能够降低错误概率，提升开发效率。对于IC设计中的各种设计模式，请读者参考相应的参考教材。

Verilog编程规范主要包括文档规范和命名规则、注释、语法规则等，下面将详细论述各个规范的内容。

## 文档规范

一个完整的软件是由程序、数据和文档三部分组成的。在FPGA电路设计中，撰写完善的设计文档是非常重要的。对于一个比较复杂的设计来说，各个子单元的功能各不相同，实现的方法也不一样，各子单元之间的信号时序和逻辑关系也是纷繁复杂的。因此在设计文档中对整个设计进行详细的描述，可以保证使用者能够在较短时间内理解和掌握整个设计方案。同时设计人员在对设计进行维护和升级时，完善的设计文档也是非常有用的。

对于IC设计而言，设计文档需要提供的内容包括：

- 文档文件头，包括作者信息、版本状态、修订内容、目的等；
- 设计所要实现的功能；
- 设计所采用的设计思路和实现原则；
- 整体组织结构；
- 整体的控制流、数据流以及I/O接口设计原则和方案；
- 整体验证思路与方案；
- 各个子单元的设计思路；
- 各个子单元之间的接口关系；
- 关键节点的位置、作用以及其测试波形的描述；
- I/O端口的名称、作用以及其测试波形的描述；

文档编写的原则包括：：

- 先总体写设计方案，然后描述详细的设计方案，两者缺一不可；
- 围绕提高测试覆盖率和验证设计系统结构的方案展开；
- 逐级时序描述，首先完成顶层时序设计，然后对单个模块进行描述。

## 编程规范

由于设计规范中存在不同的等级要求，因此针对必须遵守的规则，将其标为A级；对于强烈建议遵守的规则（某些特殊情况下除外），将其标示为B级；对于建议遵守的规则（根据实际情况可以自行进行调整的），将其标示为C级。

## 文件头定义格式

每一个Verilog文件的文件头部分都必须有一段声明的文字，以声明文件的版本、作者、修改日期以及修改内容介绍等，该文字如下所示。

```verilog
// -------------------------------------------
// Module Name:	xxxx.v
// Department: Shanghai R&D Center
// Function Description: LTE common module, CRC part
// -------------------------------------------
```

## 格式规则

- 规则1（等级B）：行首用Tab键对齐，Tab键的宽度设为4，在最终递交代码时候，由工具统一将其自动转换为空格。？？？？？

- 规则2（等级A）：Verilog HDL关键字与其他串之间留有一个空格，如：

  ```verilog
  
  ```

- 规则3（等级A）：单目运算与变量之间不留空格，如：a=( ~b )。

- 规则4（等级C）：begin_end按照如下范例进行规范：

  ```verilog
  
  ```

- 规则5（等级C）：在表达式内使用括号表示运算的优先级。

- 规则6（等级C）：一行中不能出现多个表达式。

- 规则7（等级A）：设计中使用到的0、1、z、等常数采用基数表示法书写（即表示为1'b0、1'b1、1'bz或十六进制）。

## 命名规则

命名规则主要设计信号的命名，其详细规则如下。

- 规则1（等级A），模块的命名规则：首字符使用字母‘u’意外的英文字母，而不能使用@、*、+、&等非字符字符，最多只能在中间使用一个‘_’字符，数字只能表示数据位宽及深度。
- 规则2（等级A），模块例化的命名规则：如果只例化一个，可以为：xxx_u；例化多个，为：yyy_u0、yyy_u1。其中xxx和yyy为模块名。
- 规则3（等级A），信号的命名规则（除复位和时钟外）：首字符使用除字母‘u’以外的英文字母，其他字符可以是英文字母、0~9数字以及‘_’。
- 规则4（等级A），模块对外接口信号的命名规则（除复位和时钟外）：输入接口信号为i_xxx，输出接口信号为o_xxx。其中，xxx为使用规则3命名的信号。
- 规则5（等级A），模块之间点对点接口信号的命名规则（除复位和时钟外）；u1_aaa2bbb_u2_xxx_yyy_zzz2，其中u1_aaa为源模块（例化名为aaa_u1），bbb_u2为目的模块（例化名为bbb_u2），xxx_yyy_zzz2为信号字段。
- 规则6（等级A），模块之间点对多接口信号的命名规则（除复位和时钟外）；aaa_u1_xxx_zzz2，其中aaa_u1为源例化模块名，xxx_yyy_zzz2为信号名字段。
- 规则7（等级A），时钟命名：时钟信号可以写成clk、clk_freq、xxx_clk、xxx_clk_freq。比如clk_122p88，其中频率中的小数点用p代替，xxx为英文字母，不超过4个字符。
- 规则8（等级A），异步复位的命名：异步高电平复位写为asy_rst、xxx_asy_rst、asy_rst_freq、xxx_asy_rst_freq；异步低电平复位写为asy_rst_n、xxx_asy_rst_n、asy_rst_freq_n、xxx_asy_rst_freq_n。其中，xxx为应为字母，不超过4个字符。
- 规则9（等级A）：顶层模块中的时钟信号必须标明频率，如pll_clk_61p44、adc_clk_61p44。
- 规则10（等级A）：顶层模块中同步产生、异步使用的复位信号必须注明频率，如adc_asy_rst_122p88、asy_rst_61p44。
- 规则11（等级A）：所有仿真文件的命名为xxx_sim.v，xxx为要仿真的模块名。
- 规则12（等级A）：信号延时为xxx_dlyN，其中，xxx为原始信号，N为延时拍数；信号提前为xxx_advX，其中xxx为原始信号，N为提前拍数。
- 规则13（等级B）：数（parameter）、常量（constant）和块标号（block label）名必须一致采用大写；而信号、变量、结构名（construct）以及实例标号（instance）必须一致采用小写。以利于在仿真时，区分不变和变化的数据。

## 整个体编码规则

- 规则1（等级A）：禁止采用以下代码实现同步复位。

  正常情况下，任何一个模块都可以同步复位或异步复位。但一般情况下，在同一时钟域内必须使用单一的全局同步复位电路，或者使用单一的全局异步复位电路。而大多数ASIC设计通常还需在FGPA上进行验证，而FPGA对同步与异步复位的处理方式是不一致的。为保证代码的通用性，针对ASIC设计项目，均强制使用异步复位方式，因此下述同步复位方式禁止使用：

  ```verilog
  
  
  ```

- 规则2（等级B）：建议使用同步化异步复位信号，实现电路如图1-105所示。

  图中ext_asy_rst是来自外部的复位信号，虽然asy_rst_122p88的下降沿与时钟同步，但它还是用作异步复位。原则上每一个时钟源都输出一个异步复位信号。上述电路的Verilog标准程序如下：

  ```verilog
  
  
  ```

- 规则3（等级A）：除非第三方IP指定，否则所有的异步复位必须采用统一的有效电平。

- 规则4（等级A）：RAM和FIFO的命名规则为fifo_WxD、dpram_WxD、spram_WxD。其中，‘x’前面的是位宽，后面的是深度；乘法器的命名为：mult_W1xW2，其中，W1和W2分别是乘数位宽。在例化时，后面的宽度及深度不再携带，如fifo_u1、dparm_u2、mult_u3。

- 规则5（等级A）：使用三段Moore型状态机进行状态机电路描述，状态机的电路结构如图1-106所示：

  ```verilog
  // next_state默认状态定义为不定态，便于检验状态机的完备性
  ```

  而next_state的标准实现代码如下所示：

  ```verilog
  
  ```

  时序逻辑输出的参考实现代码如下所示：

  ```verilog
  
  ```

  用这种状态机描述风格能够清晰地分离出控制逻辑代码和计算时序代码，非常利于实现模块的可控性与可观性，因此在设计规范中将其设定为强制。

- 规则6（等级B）：状态机编码使用独热码，即N个向量采用N位编码，每个向量编码中只有一位为1，其余均为0。这种独热码有助于综合器最优化状态机。

- 规则7（等级B）：对代码中的数字加注释或者使用参数。

  例如，Verilog代码else if（sg_cnt >= 8'd38）不太好理解，但是定义一个参数：parameter [7:0] UP_START_SUPGRPUP = 8'd38，则else if（sg_cnt >= UP_START_SUPGROUP）就非常容易理解。

- 规则8（等级B）：进行parameter参数定义及宏定义时，参数名及宏名必须采用大写，以示区分。

- 规则9（等级A）：对于组合逻辑，always语句的时间控制敏感列表必须完整，应包含所读取的所有变量。

- 规则10（等级B）：在条件允许的情况下，尽量使用多路选择分支结构case，而减少串行有限结构if…else if的使用。

- 规则11（等级A）：必须在if…else语句的所有分支中都对变量进行明确的赋值，否则在推导过程中产生锁存。而锁存在ASIC的DFT测试相对较为困难。

  例如，以下程序将会产生锁存电路：

  ```verilog
  
  ```

  上述代码生成的电路如下图所示。

  这里是图

  仔细阅读上述代码，就可以发现正是由于缺省的语句else out = out，产生了锁存电路。如果将代码做如下修订：

  ```verilog
  
  ```

  则在代码综合后，生成的电路如图所示，其中并没有锁存结构。

  图

- 规则12（等级A）：必须在case语句的所有分支中都对变量进行明确的赋值，且分支不完整的需要增加default分支项，否则会在推导过程汇总产生锁存。

- 规则13（等级A）：组合逻辑使用阻塞赋值‘=’，相关原理如下。

  ```verilog
  
  ```
  
  对上述代码进行仿真，假定a、b、c、d、t1、t2的原始状态0，a和b都从0变为1时，t1从0变为1，但out仍保持为0，究其原因：对于非阻塞赋值‘<=’，仿真器是同时将赋值给t1、t2、out的，而此时t1的值仍为旧值0。
  
  如果将上面的程序修改为下述程序：
  
  ```verilog
  
  ```
  
  同样，a、b、c、d、tl、t2原始状态为0，a和 b都从0变为1时，t1从0变为1，而out可以从0变为1。究其原因:对非阻塞赋值“<=”，仿真器首先执行tl赋值，其次执行2赋值，最后进行out赋值。因此在组合逻辑中使用非阻塞赋值，仿真器会产生各种无法预料的结果，综合上述，组合逻辑严禁使用非阻塞赋值。
  
- 规则14（等级A）：时序逻辑使用非阻塞赋值‘<=’，相关原理如下。
  
  对于如下Verilog代码：
  
  ```verilog
  
  
  ```
  
  生成的电路如图所示。
  
  上述错误的原因在于：阻塞语句是顺序执行的，实际执行的结果变为q3 = d。因此，需将阻塞赋值修改为非阻塞赋值，Verilog代码变为：
  
  ```verilog
  
  ```
  
  则最终生成的电路如图示，为两级触发延迟电路。
  
  图
  
  只是改变了赋值语句的顺序，就实现了一个完全不同的电路，其根源在于阻塞语句是顺序执行的，先执行q3 = q2后，q3就不再用于下面的赋值语句的右边。因此在时序电路中严禁使用阻塞语句，因为改变赋值语句的顺序就可能生成不同的电路，极易造成错误。如果使用非阻塞语句：
  
  ```verilog
  
  
  ```
  
  或者：
  
  ```verilog
  
  
  ```
  
  两段代码生成的电路图是上面的触发延迟电路，和赋值语句的摆放顺序无关。
  
- 规则15（等级A）：时序always@(posedge clk or posedge asy_rst)中只赋值一个或一组向量。若对图1-111所示复杂电路采用下述Verilog代码，这是不规范的：
  
  ```verilog
  
  ```
  
  上述代码不合理的原因在于：cont和inc_en在一个always模块中互相赋值、互相判别，逻辑不清晰。在这种情况下，应当将代码划分为两个always模块：
  
  ```verilog
  
  ```
  
- 规则16（等级A）：组合逻辑中不能引入异步复位。
  
- 规则17（等级B）：乘法器应尽量调用IP核，减少类似z = x * y逻辑的综合使用。

- 规则18（等级A）：所有的信号声明（端口类型声明与数据类型声明）定义必须放在模块接口定义的后面、功能描述体的前面。具体例子如下所示：
  
  ```verilog
  
  ```
  
- 规则19（等级C）：所例化RAM的数据延迟地址应两拍输出。
  
- 规则20（等级A）：在always过程块中，不允许出现组合逻辑与时序逻辑混编的语句。
  
- 规则21（等级A）：对于从快时钟域到慢时钟域的单位跨时钟信号，使用如图所示的电路；
  
- 规则22（等级A）：对于多位跨时钟域信号，使用FIFO或者伪双口RAM实现数据的跨时钟域转换。基于FIFO的跨时钟域标准代码如下：
  
  ```verilog
  
  ```
  
  在代码中rden有效比wren有效要延时几个rdclk，因此在FIFO开始读时，FIFO内部已经有几个有效数据深度，这个深度可以避免因rdclk与wrclk之间的抖动引起empty有效时任然进行读操作而造成FIFO的错误。
  
  严禁将wren和rden接为固定高电平，原因有两个：第一，有的FIFO要求异步复位时wren和rden不能为高电平；第二，这种电路有效数据深度可能只有1个，甚至没有，rdclk与wrclk之间的抖动容易造成当empty有效时仍然进行读操作。
  
- 规则23（等级B）：在逻辑资源及设计延迟允许的情况下，对组合逻辑应采用Pipeline流水线操作。
  
- 规则24（等级A）：组合逻辑中不能将输入反馈引回输入。
  
- 规则25（等级B）：组合逻辑输出容易产生毛刺，在寄存器资源允许的情况下，应尽量采用寄存器输出。
  
- 规则26（等级A）：进行端口申明、比较、赋值等操作时，数据位宽要匹配。
  
- 规则27（等级C）：不要给信号赋x态4，以免x值传递。
  
- 规则28（等级C）：模块中不用的输出端口用‘-nc’后缀的信号连接。
  
- 规则29（等级C）：模块中不用的输入端口用0或1的固定电平连接。

## 全局信号编码规则

表1-17是对时钟、复位等关键信号更进一步的编码规则约束。等级A。

- 在一个模块中，在时钟信号的同一个时钟沿动作。如果必须使用时钟上升沿和时钟下降沿，要分两个模块设计。
- 在设计顶层时，要专门设计时钟信号、复位信号、功率控制信号以及其他必要的全局信号。
- 除顶层外，在模块内部避免使用门控时钟和门控复位。
- 对于同步复位电路，建议在同一时钟域中使用单一的全局同步复位电路；对于异步复位电路，建议在同一时钟域中，使用单一的全局异步复位电路。
- 不要在时钟路径上添加任何缓冲器。
- 不要再复位路径上添加任何缓冲器。
- 寄存器的异步复位和异步置位信号不能同时有效。
- 避免使用组合反馈电路，尤其注意由异步复位带来的组合反馈路径。
- Always语句中的敏感事件列表要完整，否则可能会造成前后仿真结果不一致。在异步复位情况下，需要让异步复位信号和时钟沿作为敏感量，在同步复位情况下，只需要让时钟沿作为敏感量；
- 对于复杂电路，将组合逻辑和时序逻辑电路分成独立的always描述。

## 模块编码规则

表1-18中的规则是针对单个以及多个模块集成时的编码规则。

- 采用基于名字（name_based）的调用而非基于顺序的（order_based）的调用。
- 模块的接口信号按输入、双向、输出顺序定义。
- 为了保持代码的清晰、美观和层次感，一条语句占用一行，每行限制在80个字符以内，如果较长（超出80个字符），则要换行。
- 使用降序定义向量的有效顺序，最低位是0。
- 不要采用向量的方式定义一组时钟信号。
- 逻辑内部不对输入进行驱动，在模块内部不存在没有驱动源的信号，在模块端口处不能存在没有驱动的输出信号，避免在elaborate（确立，即明确内部的各种连接关系）和compile（编译）时产生警告。
- 在顶层模块汇总，除了内部的互联和模块的例化外，避免再有其他逻辑。
- 在内部模块端口处要避免双向总线，尽量在最顶层模块内处理双向总线。
- 三态逻辑可以在顶层模块使用，在子模块中禁止使用三态逻辑。如果能确保该信号不会被其他子模块使用，且直接通过顶层模块输出要用到I/O口，可以在子模块中使用三态逻辑。
- （等级B）：没有未连接的端口。
- （等级B）：为逻辑升级保留的无用端口以及信号要有注释。
- （等级B）：建议采用层次化设计，模块之间相对独立。
- （等级B）：对于层次化设计的逻辑，在升级中采用增量编译。
- （等级C）：建议每个模块加时间片。
- （等级C）：不要书写空的模块，即一个模块至少要有一个输入和一个输出。
- （等级C）：引脚和信号说明部分，一个引脚和一组总线占用一行，说明清晰。
- （等级C）：处于层次设计和同步设计的考虑，子模块建议用寄存器锁存输出信号。

## 可综合设计

对于设计的逻辑电路而言，它们必须具备可综合的性质，因此需要遵循表1-19的编码规则。

- 不要使用disable、initial等综合工具不支持的电路，而应采用复位方式进行初始化，但在testbench电路中可以使用disable、initial等。
- 不要使用specify模块。
- 不要使用\=\=\=、！\=\=等不可综合的操作符。
- 除仿真外，不要使用fork-join语句，不要使用while语句，不要使用repeat语句，不要使用forever语句不要使用系统任务（$），不要使用deassign语句，不要使用force、release语句，不要使用named events语句。
- 不要在连续赋值语句中引入驱动强度和延时。
- 禁止使用trireg型线网。
- 禁止使用tril、tir0、triand和trior型的连接。
- 不要为驱动supply0和supply1型的线网赋值。
- （等级B）在设计中不使用macro_module。
- 不要在RTL代码中实例门级单元，尤其是下列单元：CMOS/RCOMS/NMOS/PMOS/RN-MOS/RPMOS/trans/rtans/tranif0/tranif1/rtranif0/rtranif1/pull gate。
- （等级C）不要使用include语句。

## 可重用设计

如果设计的代码遵循表1-20中的规则，则具备可重用的能力。

- 在设计的顶层模块中，将I/O口、边界电路以及设计逻辑区分开。
- 考虑未使用的输入信号power_down，避免传入不稳定态。
- 将异步电路和同步电路区分开，便于综合和后端约束。
- 将相关的逻辑放在一个模块内。
- 合理划分设计的功能模块，保证模块功能的独立性。
- （等级B）合理划分模块的大小，避免模块过大。
- （等级B）接口信号尽量少，接口时序尽量简单。
- （等级B）将状态机电路与其他电路分开，便于综合和后端约束。

## 编程规范小结

前面论述了很多的设计规范，这些规范背后都隐藏这血泪教训。另外，还有很多编程规范没有涵盖在其中，例如测试编码的规范等，这些都需要读者自己去体会，主动去完善。

制定上述规范的核心目的为：

1. 保证RTL模块在逻辑综合后产生的门级网标与Verilog仿真器所理解的RTL代码行为是一致的；
2. 利用参数传递可修改代码中的常数，使得所编代码通用化，便于第三方集成；
3. 使模块分割（Partitioning）尽量优化，使每个模块都具有可重用的狗仔，便于以后的扩展。

如果理解并掌握这3点，再回头看上述的编程规范就非常清楚了，最终目的就是为了方便自己、他人、机器理解。

需要注意的是：原则上上述编程是普遍使用的，但在很多场合下可能会出现个别例外情况，例如因为工具的局限性，ASIC和FPGA使用的场景不一致等。